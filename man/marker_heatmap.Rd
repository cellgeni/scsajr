% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/scsajr.R
\name{marker_heatmap}
\alias{marker_heatmap}
\title{Plot heatmaps of alternative splicing (PSI) and gene expression (CPM) for selected markers}
\usage{
marker_heatmap(
  pbas,
  pbge,
  groupby,
  markers,
  psi_scale = FALSE,
  cpm_scale = TRUE,
  group_colors = NULL,
  col_palette = rev(grDevices::hcl.colors(100, "RdYlBu")),
  gene_names_col = NULL,
  ...
)
}
\arguments{
\item{pbas}{A \code{SummarizedExperiment} of pseudobulk splicing data. Must contain:
\itemize{
\item \code{assay(pbas, "i")} and \code{assay(pbas, "e")} (inclusion/exclusion counts).
\item \code{assay(pbas, "psi")} (percent spliced‐in) or else \code{psi} will be calculated internally.
Rows are segment IDs; columns are group labels (matching \code{colData(pbas)} grouping factor).
}}

\item{pbge}{A \code{SummarizedExperiment} of pseudobulk gene expression data. Must contain:
\itemize{
\item \code{assay(pbge, "cpm")} (counts per million).
Rows are gene IDs; columns are group labels matching \code{pbas}.
}}

\item{groupby}{A grouping label (column name in \code{colData(pbas)} and \code{colData(pbge)})
used to aggregate and order groups. Can be a single column name or a vector of column names;
see \code{get_groupby_factor()} for details.}

\item{markers}{A data.frame of selected marker segments. Must contain columns:
\itemize{
\item \code{seg_id} (segment ID matching \code{rownames(pbas)})
\item \code{dpsi} (delta‐PSI sign and magnitude; positive means inclusion in higher group)
\item \code{group} (group label for which this segment is a marker)
\item \code{is_marker} (logical; \code{TRUE} for top per‐group markers, \code{FALSE} for background markers)
Optionally, \code{markers} may contain a column \code{gene_id} if plotting gene names.
}}

\item{psi_scale}{Logical; if \code{TRUE}, PSI values are scaled (z‐score) per segment (column of heatmap). Default is \code{FALSE} (raw PSI in (0,1)).}

\item{cpm_scale}{Logical; if \code{TRUE}, CPM values are standardized (z‐score) per gene (column of heatmap). Default is \code{TRUE}.}

\item{group_colors}{Optional named vector mapping group labels to colors. If \code{NULL}, default colors are assigned via \code{char2col()}.}

\item{col_palette}{A vector of colors (length ≥ 2) for heatmap coloring (e.g., \code{rev(hcl.colors(100, "RdYlBu"))}). Default is \code{rev(hcl.colors(100, "RdYlBu"))}.}

\item{gene_names_col}{Optional character. If \code{markers} has a column with gene names (e.g., \code{"name"}),
specify it here so gene names appear in the column labels of the heatmap. Default is \code{NULL}.}

\item{...}{Additional arguments passed to underlying plotting functions (\code{imageWithText}, \code{plotColorLegend2}).}
}
\value{
Invisibly returns \code{NULL}. The function draws two heatmaps in the current graphics device:
\itemize{
\item Left: PSI heatmap, with rows = groups, columns = marker segments.
\item Right: CPM heatmap, with rows = groups, columns = corresponding genes.
If scaling is applied (\code{psi_scale} or \code{cpm_scale}), legends reflect z‐score ranges.
}
}
\description{
This function takes pseudobulk splicing data (\code{pbas}) and gene expression data (\code{pbge}),
along with a set of marker segments, and plots two side‐by‐side heatmaps:
\enumerate{
\item PSI values (percent spliced‐in) for each marker segment across groups.
\item CPM values (counts per million) for corresponding genes across groups.
}
}
\details{
\enumerate{
\item Calls \code{pseudobulk()} on \code{pbas} and \code{pbge} to ensure group‐level assays (\code{psi} and \code{cpm}) exist.
\item Extracts a PSI matrix (\code{psi_mat}) of size (n_groups × n_markers) for \code{markers$seg_id}.
\itemize{
\item If \code{markers$dpsi} is negative, flips PSI to \verb{1 − PSI} so that all markers align directionally.
}
\item Determines group ordering via classical Multidimensional Scaling (MDS) on \code{psi_mat} correlations, so that similar groups cluster together.
\item Reorders \code{markers} by \code{markers$group} matching MDS order, then by \code{dpsi}.
\item Extracts CPM matrix (\code{cpm_mat}) of size (n_groups × n_genes) for genes corresponding to \code{markers$seg_id}.
\itemize{
\item If \code{gene_names_col} is provided, column names become \code{paste0(gene_name, ":", seg_id)}.
}
\item Scales \code{psi_mat} and/or \code{cpm_mat} if requested (\code{psi_scale}, \code{cpm_scale}).
\item Prepares row annotations (\code{row_anns}) with:
\itemize{
\item \code{ct}: group label
\item \code{is_marker}: color \code{gray}/\code{white} for \code{TRUE}/\code{FALSE}
\item \code{psi_flipped}: whether a marker’s \code{dpsi < 0} (flipped direction; same gray/white legend).
}
\item Draws two heatmaps side‐by‐side:
\itemize{
\item \strong{PSI heatmap}: calls \code{imageWithText()} with \code{psi_mat}, coloring by \code{col_palette}, showing \code{ct} annotation.
\item \strong{PSI legend}: if \code{psi_scale = FALSE}, calls \code{plotColorLegend2()} to display color scale (0,1) or z‐score limits.
\item \strong{CPM heatmap}: calls \code{imageWithText()} with \code{cpm_mat}, similar annotations.
\item \strong{CPM legend}: calls \code{plotColorLegend2()} to show z‐score or raw CPM scale.
}
}
}
\seealso{
\code{\link{pseudobulk}}, \code{\link{calc_psi}}, \code{\link{calc_cpm}}, \code{\link{get_groupby_factor}}
}
